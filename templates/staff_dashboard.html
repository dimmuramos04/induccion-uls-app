{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card card-custom h-100">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h2 class="text-uls-blue fw-bold mb-0">
                    <i class="fas {{ current_user.stand_asignado.icono }} me-2 
                    {% if current_user.stand_asignado.tipo == 'entrega' %}text-uls-red{% endif %}"></i>
    
                    {{ current_user.stand_asignado.nombre }}
                </h2>
                <span class="badge bg-secondary rounded-pill mt-2">
                    Modo: {{ current_user.stand_asignado.tipo | upper }}
                </span>
            </div>
            
            <div class="card-body px-4 text-center">
                <div class="my-4">
                    <h5 class="mb-3">Esc√°ner de C√©dula</h5>
                    <div style="width: 100%; max-width: 500px; margin: auto; position: relative;">
                        <video id="reader" style="width: 100%; height: auto; border: 2px solid #dee2e6; border-radius: 8px; display:none;"></video>
                        <div id="reader-fallback" style="width: 100%; display: none;"></div>
                    </div>
                    <div class="mt-3">
                        <button id="btn-scan" class="btn btn-outline-primary">
                            <i class="fas fa-play"></i> Activar C√°mara
                        </button>
                        <button id="btn-stop" class="btn btn-outline-danger d-none">
                            <i class="fas fa-stop"></i> Detener
                        </button>
                        
                        <input type="file" id="file-scan" accept="image/*" capture="environment" hidden>
                        <button id="btn-photo" class="btn btn-outline-dark d-none ms-2">
                            <i class="fas fa-camera"></i> Foto (iOS)
                        </button>
                    </div>
                </div>

                <div class="input-group mb-3 w-75 mx-auto">
                    <input type="text" id="manual-rut" class="form-control" placeholder="Ingreso manual (Ej: 11111111-1)">
                    <button class="btn btn-secondary" type="button" id="btn-validar">Validar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div id="result-card" class="card card-custom bg-light mb-3" style="display:none;">
            <div class="card-body text-center">
                
                <h4 id="alumno-nombre" class="fw-bold">Procesando...</h4>
                <p id="alumno-carrera" class="text-muted mb-3">--</p>
                
                <hr>
                
                <div id="mensaje-estado" class="alert" style="display:none;"></div>

                <div id="zona-qr" style="display:none;" class="animate__animated animate__fadeIn">
                    <div class="bg-white p-2 d-inline-block border border-2 border-dark rounded mb-3">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://forms.gle/hYaRYwd4tFPSp5zq8" 
                             alt="QR Encuesta" width="150">
                    </div>
                    <p class="small text-muted fw-bold">Scan√©ame para la Encuesta</p>
                </div>

                <button class="btn btn-outline-primary w-100 mt-2" onclick="resetUI()">
                    <i class="fas fa-redo"></i> Siguiente Estudiante
                </button>
            </div>
        </div>
        
        <div class="card card-custom p-3 bg-white">
            <h6><i class="fas fa-info-circle text-uls-blue"></i> Instrucciones</h6>
            <ul class="small text-muted ps-3 mb-0">
                <li>Enfoca el c√≥digo de barras o QR.</li>
                <li>Si el carnet est√° da√±ado, escribe el RUT.</li>
                <li>Espera el "BEEP" de confirmaci√≥n.</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. OBTENER TOKEN DE SEGURIDAD DESDE FLASK
    const csrfToken = "{{ csrf_token() }}"; 
</script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>


<script>
    // --- CONFIGURACI√ìN DE SONIDOS (LOCALES) ---
    const beepSuccess = new Audio("{{ url_for('static', filename='sounds/success.mp3') }}"); 
    const beepError = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");

    function desbloquearAudio() {
        beepSuccess.volume = 0.1; 
        beepSuccess.play().then(() => { 
            beepSuccess.pause(); 
            beepSuccess.currentTime = 0; 
            beepSuccess.volume = 1.0; // Restauramos volumen
        }).catch((e) => console.log("Audio waiting...", e));
        
        beepError.volume = 0.1;
        beepError.play().then(() => { 
            beepError.pause(); 
            beepError.currentTime = 0; 
            beepError.volume = 1.0; 
        }).catch((e) => console.log("Audio waiting...", e));
    }
</script>

<script>
    let videoStream = null;
    let isScanning = false;
    let barcodeDetector = null;
    let detectionLoop = null;

    // ==========================================
    // DETECCI√ìN DE DISPOSITIVO
    // ==========================================
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const supportsBarcodeDetector = 'BarcodeDetector' in window;

    console.log("üì± Dispositivo:", isIOS ? "iOS" : "Android/Otro");
    console.log("üîç BarcodeDetector:", supportsBarcodeDetector ? "Soportado" : "No soportado");

    // ==========================================
    // FUNCIONES AUXILIARES (LIMPIEZA DE RUT)
    // ==========================================

    // Busca un patr√≥n de RUT (ej: 12.345.678-9 o 12345678-9) dentro de cualquier texto o URL
    function extraerRutDeTexto(texto) {
        // Expresi√≥n regular que busca: Numeros + Puntos(opcional) + Gui√≥n + Digito/K
        const patronRut = /(\d{1,2}(\.?\d{3}){2}-[\dkK])/;
        const coincidencia = texto.match(patronRut);
        
        if (coincidencia) {
            console.log("RUT extra√≠do de URL/Texto:", coincidencia[0]);
            return coincidencia[0];
        }
        // Si no encontr√≥ patr√≥n de RUT, devuelve el texto original (tal vez era un QR simple)
        return texto;
    }

    // ==========================================
    // ANDROID: BARCODE DETECTOR (Tiempo Real)
    // ==========================================

    async function iniciarEscanerNativo() {
        try {
            // Crear detector con todos los formatos posibles
            const formats = await BarcodeDetector.getSupportedFormats();
            console.log("üìã Formatos soportados:", formats);
        
            barcodeDetector = new BarcodeDetector({ formats: formats });

            // Obtener stream de video
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });

            const videoElement = document.getElementById('reader');
            videoElement.style.display = 'block'; // Mostrar video nativo
            videoElement.srcObject = videoStream;
            videoElement.play();

            // Iniciar detecci√≥n continua
            detectionLoop = setInterval(async () => {
                if (isScanning) return;

                try {
                    const barcodes = await barcodeDetector.detect(videoElement);
                
                    if (barcodes.length > 0) {
                        console.log("‚úÖ C√≥digo detectado:", barcodes[0]);
                        isScanning = true;
                    
                        const texto = barcodes[0].rawValue;
                        console.log("üìÑ Contenido:", texto);
                        console.log("üìã Formato:", barcodes[0].format);
                    
                        const rutLimpio = extraerRutDeTexto(texto);
                        procesarRut(rutLimpio);
                    }
                } catch (err) {
                    console.error("Error en detecci√≥n:", err);
                }
            }, 300); // Escanea cada 300ms

            document.getElementById('btn-scan').classList.add('d-none');
            document.getElementById('btn-stop').classList.remove('d-none');
        
            console.log("‚úÖ Esc√°ner nativo iniciado");

        } catch (err) {
            console.error("‚ùå Error:", err);
            
            let mensaje = "No se pudo iniciar la c√°mara.\n\n";
            if (err.name === 'NotAllowedError') {
                mensaje += "üö´ Debes permitir el acceso a la c√°mara.";
            } else if (err.name === 'NotFoundError') {
                mensaje += "üì∑ No se encontr√≥ c√°mara en tu dispositivo.";
            } else {
                mensaje += err.message;
            }
            alert(mensaje);
        }
    }

    function detenerEscaner() {
        if (detectionLoop) {
            clearInterval(detectionLoop);
            detectionLoop = null;
        }
    
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    
        const videoElement = document.getElementById('reader');
        videoElement.pause();
        videoElement.srcObject = null;
        videoElement.style.display = 'none'; // Ocultar
    
        document.getElementById('btn-scan').classList.remove('d-none');
        document.getElementById('btn-stop').classList.add('d-none');
    
        console.log("üõë Esc√°ner detenido");
    }

    // ==========================================
    // iOS: CAPTURA DE FOTO (Sin video en vivo)
    // ==========================================
    const fileInput = document.getElementById('file-scan');

    function activarCapturaiOS() {
        console.log("üçé Activando captura de foto iOS...");
        
        // No mostrar video, solo bot√≥n de foto
        document.getElementById('btn-scan').classList.add('d-none');
        document.getElementById('btn-photo').classList.remove('d-none');
        document.getElementById('btn-stop').classList.remove('d-none');
        
        alert("üì∏ En iPhone, presiona el bot√≥n 'Foto (iOS)' para tomar una imagen del carnet.");
    }

    function detenerCapturaiOS() {
        document.getElementById('btn-scan').classList.remove('d-none');
        document.getElementById('btn-photo').classList.add('d-none');
        document.getElementById('btn-stop').classList.add('d-none');
    }

    document.getElementById('btn-photo').addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        console.log("üì∏ Procesando foto...");

        // Mostrar feedback visual
        const nombreEl = document.getElementById('alumno-nombre');
        const resultCard = document.getElementById('result-card');
        resultCard.style.display = 'block';
        nombreEl.innerText = "Procesando foto...";
        nombreEl.className = "fw-bold text-info";

        try {
            // Crear elemento temporal oculto SOLO para esta lectura
            const tempDiv = document.createElement('div');
            tempDiv.id = 'temp-reader-' + Date.now();
            tempDiv.style.display = 'none';
            document.body.appendChild(tempDiv);
            
            // Crear instancia temporal
            const html5QrCode = new Html5Qrcode(tempDiv.id, {
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.PDF_417,
                    Html5QrcodeSupportedFormats.DATA_MATRIX,
                    Html5QrcodeSupportedFormats.AZTEC
                ],
                verbose: true
            });
            
            // Intentar leer la foto
            const decodedText = await html5QrCode.scanFile(file, false); // false = no mostrar imagen
            
            console.log("‚úÖ Foto decodificada:", decodedText);
            
            // Limpiar
            await html5QrCode.clear();
            document.body.removeChild(tempDiv);
            
            // Procesar RUT
            const rutLimpio = extraerRutDeTexto(decodedText);
            procesarRut(rutLimpio);
            
        } catch (err) {
            console.error("‚ùå Error leyendo foto:", err);
            beepError.play();

            // Ocultar card de resultado
            resultCard.style.display = 'none';
            
            alert("No se pudo leer el c√≥digo de la foto.\n\n" +
                  "üì± TIPS PARA CARNETS ANTIGUOS (PDF417):\n" +
                  "‚úì Ac√©rcate M√ÅS (5-10cm del c√≥digo)\n" +
                  "‚úì Usa MUCHA luz (exterior o l√°mpara directa)\n" +
                  "‚úì Mant√©n el celular TOTALMENTE quieto\n" +
                  "‚úì Evita TODOS los reflejos del pl√°stico\n" +
                  "‚úì El c√≥digo es el de BARRAS (no el chip)\n\n" +
                  "üÜï CARNETS NUEVOS: Usa el QR cuadrado\n\n" +
                  "‚å®Ô∏è Si falla, ingresa el RUT manualmente");
        } finally {
            // Resetear input para permitir tomar otra foto
            e.target.value = '';
        }
    });


    // ==========================================
    // EVENTOS DE BOTONES
    // ==========================================
    document.getElementById('btn-scan').addEventListener('click', function() {
        desbloquearAudio();
        
        if (isIOS || !supportsBarcodeDetector) {
            // iPhone o navegador sin BarcodeDetector
            activarCapturaiOS();
        } else {
            // Android con Chrome/Edge
            iniciarEscanerNativo();
        }
    });

    document.getElementById('btn-stop').addEventListener('click', function() {
        if (isIOS || !supportsBarcodeDetector) {
            detenerCapturaiOS();
        } else {
            detenerEscaner();
        }
    });

    // ==========================================
    // PROCESAMIENTO DE RUT
    // ==========================================
    function procesarRut(rut) {
        // Preparar UI
        const resultCard = document.getElementById('result-card');
        const nombreEl = document.getElementById('alumno-nombre');
        const carreraEl = document.getElementById('alumno-carrera');
        const msgEl = document.getElementById('mensaje-estado');
        const qrEl = document.getElementById('zona-qr');
        
        // Resetear visual
        resultCard.style.display = 'block';
        msgEl.style.display = 'none';
        qrEl.style.display = 'none';
        nombreEl.innerText = "Buscando...";
        nombreEl.className = "fw-bold text-muted";
        
        isScanning = true; // Bloquear lecturas

        fetch('/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json',
                          'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ rut: rut })
        })
        .then(response => response.json())
        .then(data => {
            // Mostrar Datos B√°sicos
            if (data.estudiante) {
                nombreEl.innerText = data.estudiante.nombre || "Desconocido";
                carreraEl.innerText = data.estudiante.carrera || "";
            }

            msgEl.style.display = 'block';
            msgEl.className = 'alert'; // Reset clases

            if (data.status === 'success') {
                beepSuccess.play();
                nombreEl.className = "fw-bold text-success";
                
                // Configurar Mensaje √âxito
                msgEl.classList.add('alert-success');
                msgEl.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;

                // MOSTRAR QR SI ES REGALO
                if (data.message.includes("Entrega") || data.message.includes("registrada")) {
                    // Verificamos si el mensaje viene del stand de regalos
                    if("{{ current_user.stand_asignado.tipo }}" === "entrega"){
                         qrEl.style.display = 'block';
                    }
                }

            } else if (data.status === 'warning') {
                beepError.play();
                nombreEl.className = "fw-bold text-warning";
                msgEl.classList.add('alert-warning');
                msgEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.message}`;
                
            } else {
                // Error (No encontrado)
                beepError.play();
                nombreEl.innerText = "No Encontrado";
                nombreEl.className = "fw-bold text-danger";
                msgEl.classList.add('alert-danger');
                msgEl.innerText = data.message;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error de conexi√≥n");
        })
        .finally(() => {
            // No reactivamos scanner autom√°ticamente para dar tiempo de ver el resultado
        });
    }

    // --- LIMPIAR PANTALLA ---
    function resetUI() {
        document.getElementById('result-card').style.display = 'none';
        document.getElementById('manual-rut').value = '';
        isScanning = false; // Permitir escanear de nuevo
    }

    // ==========================================
    // VALIDACI√ìN MANUAL
    // ==========================================
    const manualInput = document.getElementById('manual-rut');
    const manualBtn = document.getElementById('btn-validar');

    manualBtn.addEventListener('click', () => {
        const rut = manualInput.value;
        if(rut) {
            procesarRut(rut);
            manualInput.value = ''; 
        }
    });

    manualInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') manualBtn.click();
    });
</script>
{% endblock %}
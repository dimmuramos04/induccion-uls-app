{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card card-custom h-100">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h2 class="text-uls-blue fw-bold mb-0">
                    <i class="fas {{ current_user.stand_asignado.icono }} me-2 
                    {% if current_user.stand_asignado.tipo == 'entrega' %}text-uls-red{% endif %}"></i>
    
                    {{ current_user.stand_asignado.nombre }}
                </h2>
                <span class="badge bg-secondary rounded-pill mt-2">
                    Modo: {{ current_user.stand_asignado.tipo | upper }}
                </span>
            </div>
            
            <div class="card-body px-4 text-center">
                <div class="my-4">
                    <h5 class="mb-3">Esc√°ner de C√©dula</h5>
                    <div style="width: 100%; max-width: 500px; margin: auto; position: relative;">
                        <video id="reader" style="width: 100%; height: auto; border: 2px solid #dee2e6; border-radius: 8px; display:none;"></video>
                        <div id="reader-fallback" style="width: 100%;"></div>
                    </div>
                    <div class="mt-3">
                        <button id="btn-scan" class="btn btn-outline-primary">
                            <i class="fas fa-play"></i> Activar C√°mara
                        </button>
                        <button id="btn-stop" class="btn btn-outline-danger d-none">
                            <i class="fas fa-stop"></i> Detener
                        </button>
                        
                        <input type="file" id="file-scan" accept="image/*" capture="environment" hidden>
                        <button id="btn-photo" class="btn btn-outline-dark d-none ms-2">
                            <i class="fas fa-camera"></i> Foto (iOS)
                        </button>
                    </div>
                </div>

                <div class="input-group mb-3 w-75 mx-auto">
                    <input type="text" id="manual-rut" class="form-control" placeholder="Ingreso manual (Ej: 11111111-1)">
                    <button class="btn btn-secondary" type="button" id="btn-validar">Validar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div id="result-card" class="card card-custom bg-light mb-3" style="display:none;">
            <div class="card-body text-center">
                
                <h4 id="alumno-nombre" class="fw-bold">Procesando...</h4>
                <p id="alumno-carrera" class="text-muted mb-3">--</p>
                
                <hr>
                
                <div id="mensaje-estado" class="alert" style="display:none;"></div>

                <div id="zona-qr" style="display:none;" class="animate__animated animate__fadeIn">
                    <div class="bg-white p-2 d-inline-block border border-2 border-dark rounded mb-3">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://forms.gle/TU_LINK_AQUI" 
                             alt="QR Encuesta" width="150">
                    </div>
                    <p class="small text-muted fw-bold">Scan√©ame para la Encuesta</p>
                </div>

                <button class="btn btn-outline-primary w-100 mt-2" onclick="resetUI()">
                    <i class="fas fa-redo"></i> Siguiente Estudiante
                </button>
            </div>
        </div>
        
        <div class="card card-custom p-3 bg-white">
            <h6><i class="fas fa-info-circle text-uls-blue"></i> Instrucciones</h6>
            <ul class="small text-muted ps-3 mb-0">
                <li>Enfoca el c√≥digo de barras o QR.</li>
                <li>Si el carnet est√° da√±ado, escribe el RUT.</li>
                <li>Espera el "BEEP" de confirmaci√≥n.</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. OBTENER TOKEN DE SEGURIDAD DESDE FLASK
    const csrfToken = "{{ csrf_token() }}"; 
</script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>


<script>
    // --- CONFIGURACI√ìN DE SONIDOS (LOCALES) ---
    const beepSuccess = new Audio("{{ url_for('static', filename='sounds/success.mp3') }}"); 
    const beepError = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");

    function desbloquearAudio() {
        beepSuccess.volume = 0.1; 
        beepSuccess.play().then(() => { 
            beepSuccess.pause(); 
            beepSuccess.currentTime = 0; 
            beepSuccess.volume = 1.0; // Restauramos volumen
        }).catch((e) => console.log("Audio waiting...", e));
        
        beepError.volume = 0.1;
        beepError.play().then(() => { 
            beepError.pause(); 
            beepError.currentTime = 0; 
            beepError.volume = 1.0; 
        }).catch((e) => console.log("Audio waiting...", e));
    }
</script>

<script>
    let videoStream = null;
    let isScanning = false;
    let barcodeDetector = null;
    let detectionLoop = null;
    let html5QrCode = null; // Instancia para el fallback (iOS)

    // ==========================================
    // 1. FUNCIONES AUXILIARES (LIMPIEZA DE RUT)
    // ==========================================

    // Busca un patr√≥n de RUT (ej: 12.345.678-9 o 12345678-9) dentro de cualquier texto o URL
    function extraerRutDeTexto(texto) {
        // Expresi√≥n regular que busca: Numeros + Puntos(opcional) + Gui√≥n + Digito/K
        const patronRut = /(\d{1,2}(\.?\d{3}){2}-[\dkK])/;
        const coincidencia = texto.match(patronRut);
        
        if (coincidencia) {
            console.log("RUT extra√≠do de URL/Texto:", coincidencia[0]);
            return coincidencia[0];
        }
        // Si no encontr√≥ patr√≥n de RUT, devuelve el texto original (tal vez era un QR simple)
        return texto;
    }

    // ==========================================
    // 2. DETECTOR NATIVO DE C√ìDIGOS
    // ==========================================

    async function iniciarEscanerNativo() {
        try {
            // Verificar si el navegador soporta BarcodeDetector
            if (!('BarcodeDetector' in window)) {
                throw new Error('BarcodeDetector no soportado. Usa Chrome/Edge en Android.');
            }

            // Crear detector con todos los formatos posibles
            const formats = await BarcodeDetector.getSupportedFormats();
            console.log("üìã Formatos soportados:", formats);
        
            barcodeDetector = new BarcodeDetector({ formats: formats });

            // Obtener stream de video
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });

            const videoElement = document.getElementById('reader');
            videoElement.style.display = 'block'; // Mostrar video nativo
            videoElement.srcObject = videoStream;
            videoElement.play();

            // Iniciar detecci√≥n continua
            detectionLoop = setInterval(async () => {
                if (isScanning) return;

                try {
                    const barcodes = await barcodeDetector.detect(videoElement);
                
                    if (barcodes.length > 0) {
                        console.log("‚úÖ C√≥digo detectado:", barcodes[0]);
                        isScanning = true;
                    
                        const texto = barcodes[0].rawValue;
                        console.log("üìÑ Contenido:", texto);
                    
                        const rutLimpio = extraerRutDeTexto(texto);
                        procesarRut(rutLimpio);
                    }
                } catch (err) {
                    console.error("Error en detecci√≥n:", err);
                }
            }, 500); // Escanea cada 500ms

            document.getElementById('btn-scan').classList.add('d-none');
            document.getElementById('btn-stop').classList.remove('d-none');
        
            console.log("‚úÖ Esc√°ner nativo iniciado");

        } catch (err) {
            console.error("‚ùå Error:", err);
            alert("Error: " + err.message);
        }
    }

    function detenerEscaner() {
        if (detectionLoop) {
            clearInterval(detectionLoop);
            detectionLoop = null;
        }
    
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    
        const videoElement = document.getElementById('reader');
        videoElement.pause();
        videoElement.srcObject = null;
        videoElement.style.display = 'none'; // Ocultar
    
        document.getElementById('btn-scan').classList.remove('d-none');
        document.getElementById('btn-stop').classList.add('d-none');
    
        console.log("üõë Esc√°ner detenido");
    }

    // ==========================================
    // 3. EVENTOS DE BOTONES
    // ==========================================

    document.getElementById('btn-scan').addEventListener('click', function() {
        desbloquearAudio();
        
        if ('BarcodeDetector' in window) {
            // Opci√≥n A: Navegador Moderno (Android/Chrome) - Tu c√≥digo actual
            iniciarEscanerNativo();
        } else {
            // Opci√≥n B: iOS / Safari (Fallback)
            iniciarEscanerCompatibilidad();
        }
    });

    document.getElementById('btn-stop').addEventListener('click', function() {
        if ('BarcodeDetector' in window) {
            detenerEscaner();
        } else {
            detenerEscanerCompatibilidad();
        }
    }); 

    // ==========================================
    // 4. ESC√ÅNER COMPATIBILIDAD (iOS/Fallback)
    // ==========================================
    
    function iniciarEscanerCompatibilidad() {
        console.log("üçé Iniciando modo compatibilidad iOS...");
        
        // Mostrar bot√≥n de Foto como alternativa robusta
        document.getElementById('btn-photo').classList.remove('d-none');
        document.getElementById('btn-scan').classList.add('d-none');
        document.getElementById('btn-stop').classList.remove('d-none');

        // Inicializar librer√≠a
        if(!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader-fallback");
        }
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // Intentar escanear QR y PDF417
        html5QrCode.start({ facingMode: "environment" }, config, 
            (decodedText, decodedResult) => {
                // √âxito
                console.log("Compatibilidad Scan:", decodedText);
                detenerEscanerCompatibilidad();
                const rutLimpio = extraerRutDeTexto(decodedText);
                procesarRut(rutLimpio);
            },
            (errorMessage) => {
                // Error de lectura frame a frame (ignorar)
            }
        ).catch(err => {
            console.error("Error iniciando c√°mara fallback:", err);
            alert("No se pudo iniciar la c√°mara en vivo. Usa el bot√≥n 'Foto (iOS)' que aparecer√° ahora.");
        });
    }

    function detenerEscanerCompatibilidad() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                document.getElementById('btn-scan').classList.remove('d-none');
                document.getElementById('btn-stop').classList.add('d-none');
                document.getElementById('btn-photo').classList.add('d-none');
            }).catch(err => {
                console.log("Error stop fallback", err);
                // Forzar reset UI si falla el stop
                document.getElementById('btn-scan').classList.remove('d-none');
                document.getElementById('btn-stop').classList.add('d-none');
            });
        }
    }

    // --- L√ìGICA FOTO (iOS "Silver Bullet") ---
    // Esta es la mejor opci√≥n para leer Carnet en iPhone si el video falla por resoluci√≥n
    const fileInput = document.getElementById('file-scan');
    const btnPhoto = document.getElementById('btn-photo');

    btnPhoto.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', e => {
        if (e.target.files.length == 0) return;

        const imageFile = e.target.files[0];
        
        // Usamos la instancia global si ya existe para evitar errores de "Elemento en uso"
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader-fallback");
        }
        
        html5QrCode.scanFile(imageFile, true)
        .then(decodedText => {
            console.log("Foto decodificada:", decodedText);
            const rutLimpio = extraerRutDeTexto(decodedText);
            procesarRut(rutLimpio);
        })
        .catch(err => {
            console.error("Error leyendo foto:", err);
            alert("No se pudo leer el c√≥digo de la foto. Intenta acercarte m√°s, limpiar el lente o mejorar la luz.");
        });
    });

    // --- 2. L√ìGICA DE PROCESAMIENTO ---
    function procesarRut(rut) {
        // Preparar UI
        const resultCard = document.getElementById('result-card');
        const nombreEl = document.getElementById('alumno-nombre');
        const carreraEl = document.getElementById('alumno-carrera');
        const msgEl = document.getElementById('mensaje-estado');
        const qrEl = document.getElementById('zona-qr');
        
        // Resetear visual
        resultCard.style.display = 'block';
        msgEl.style.display = 'none';
        qrEl.style.display = 'none';
        nombreEl.innerText = "Buscando...";
        nombreEl.className = "fw-bold text-muted";
        
        isScanning = true; // Bloquear lecturas

        fetch('/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json',
                          'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ rut: rut })
        })
        .then(response => response.json())
        .then(data => {
            // Mostrar Datos B√°sicos
            if (data.estudiante) {
                nombreEl.innerText = data.estudiante.nombre || "Desconocido";
                carreraEl.innerText = data.estudiante.carrera || "";
            }

            msgEl.style.display = 'block';
            msgEl.className = 'alert'; // Reset clases

            if (data.status === 'success') {
                beepSuccess.play();
                nombreEl.className = "fw-bold text-success";
                
                // Configurar Mensaje √âxito
                msgEl.classList.add('alert-success');
                msgEl.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;

                // MOSTRAR QR SI ES REGALO
                if (data.message.includes("Entrega") || data.message.includes("registrada")) {
                    // Verificamos si el mensaje viene del stand de regalos
                    if("{{ current_user.stand_asignado.tipo }}" === "entrega"){
                         qrEl.style.display = 'block';
                    }
                }

            } else if (data.status === 'warning') {
                beepError.play();
                nombreEl.className = "fw-bold text-warning";
                msgEl.classList.add('alert-warning');
                msgEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.message}`;
                
            } else {
                // Error (No encontrado)
                beepError.play();
                nombreEl.innerText = "No Encontrado";
                nombreEl.className = "fw-bold text-danger";
                msgEl.classList.add('alert-danger');
                msgEl.innerText = data.message;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error de conexi√≥n");
        })
        .finally(() => {
            // No reactivamos scanner autom√°ticamente para dar tiempo de ver el resultado
        });
    }

    // --- 3. LIMPIAR PANTALLA ---
    function resetUI() {
        document.getElementById('result-card').style.display = 'none';
        document.getElementById('manual-rut').value = '';
        isScanning = false; // Permitir escanear de nuevo
    }

    // --- 4. VALIDACI√ìN MANUAL ---
    const manualInput = document.getElementById('manual-rut');
    const manualBtn = document.getElementById('btn-validar');

    manualBtn.addEventListener('click', () => {
        const rut = manualInput.value;
        if(rut) {
            procesarRut(rut);
            manualInput.value = ''; 
        }
    });

    manualInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') manualBtn.click();
    });
</script>
{% endblock %}
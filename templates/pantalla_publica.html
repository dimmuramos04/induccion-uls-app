<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gran Sorteo ULS 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            background: radial-gradient(circle, #003366 0%, #001a33 100%); /* Azul ULS oscuro */
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
        }

        .titulo-sorteo {
            font-size: 3rem;
            color: #ffc107; /* Amarillo */
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            margin-bottom: 50px;
            letter-spacing: 5px;
        }

        /* CAJA DEL NOMBRE (EFECTO TRAGAMONEDAS) */
        .slot-machine {
            background: rgba(255, 255, 255, 0.1);
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 40px 80px;
            text-align: center;
            min-width: 80%;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .slot-machine.winner {
            transform: scale(1.1);
            border-color: #28a745; /* Verde √©xito */
            background: rgba(40, 167, 69, 0.2);
            box-shadow: 0 0 100px rgba(40, 167, 69, 0.8);
            animation: glow 1s infinite alternate;
        }

        #nombre-display {
            font-size: 5rem;
            font-weight: 900;
            line-height: 1.2;
        }

        #carrera-display {
            font-size: 2rem;
            color: #adb5bd;
            margin-top: 10px;
            font-weight: 400;
        }

        .hidden { opacity: 0; }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px #28a745; }
            to { box-shadow: 0 0 60px #28a745, 0 0 20px white; }
        }
    </style>
</head>
<body>

    <h1 class="titulo-sorteo">üèÜ GRAN SORTEO SEMANA DE INDUCCI√ìN 2026 USERENA üèÜ</h1>

    <div class="slot-machine" id="caja-sorteo">
        <div id="nombre-display">ESPERANDO...</div>
        <div id="carrera-display" class="hidden">-</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // Conexi√≥n forzada a Websockets
        const socket = io({transports: ['websocket', 'polling']});
        
        const displayNombre = document.getElementById('nombre-display');
        const displayCarrera = document.getElementById('carrera-display');
        const caja = document.getElementById('caja-sorteo');
        
        // Sonidos Online (Funcionan directo)
        const audioDrum = new Audio("{{ url_for('static', filename='sounds/drumroll.mp3') }}"); 
        const audioWin = new Audio("{{ url_for('static', filename='sounds/winner(1).mp3') }}");
        audioDrum.volume = 1.0;
        audioWin.volume = 1.0;
        
        // Nombres falsos para la animaci√≥n
        const nombresFalsos = ["Javiera...", "Mat√≠as...", "Constanza...", "Diego...", "Valentina...", "Sebasti√°n...", "Camila...", "Nicol√°s...", "Isabela...", "Gabriel...", "FELIPE...", "Antonia...", "Benjam√≠n...", "Sof√≠a...", "Mateo...", "Marcos...", "Emilia...", "Alexis...", "Lucas...", "Melissa..."];

        // 1. ESCUCHAR EL INICIO DEL SORTEO
        socket.on('iniciar_animacion', (data) => {
            console.log("üèÜ Datos recibidos:", data);
            startRoulette(data);
        });

        // 2. ESCUCHAR EL RESET (LIMPIAR PANTALLA)
        socket.on('limpiar_pantalla', () => {
            console.log("üßπ Limpiando...");
            audioWin.pause();
            audioWin.currentTime = 0;
            audioDrum.pause();
            audioDrum.currentTime = 0;

            caja.classList.remove('winner');
            displayNombre.innerText = "ESPERANDO...";
            displayNombre.style.color = "white";
            displayCarrera.classList.add('hidden');
        });

        function startRoulette(ganador) {
            // Reset visual
            caja.classList.remove('winner');
            displayCarrera.classList.add('hidden');
            displayNombre.style.color = "white";
            
            // Intentar reproducir audio (requiere que hayas hecho clic en la p√°gina una vez antes)
            audioDrum.currentTime = 0;
            audioDrum.play().catch(e => console.log("‚ö†Ô∏è Haz clic en la pantalla para activar el audio"));

            // Animaci√≥n
            const intervalTime = 100;
            const duration = 4000; 

            const interval = setInterval(() => {
                displayNombre.innerText = nombresFalsos[Math.floor(Math.random() * nombresFalsos.length)];
            }, intervalTime);

            setTimeout(() => {
                clearInterval(interval);
                audioDrum.pause();
                
                // Mostrar Ganador
                displayNombre.innerText = ganador.nombre;
                displayCarrera.innerText = ganador.carrera;
                displayCarrera.classList.remove('hidden');

                // Victoria
                caja.classList.add('winner');
                audioWin.play().catch(e => console.log("Audio bloqueado"));
                lanzarConfetti();

            }, duration);
        }

        function lanzarConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } }));
            }, 250);
        }
    </script>
</body>
</html>